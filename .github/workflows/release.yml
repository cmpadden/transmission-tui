name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'SemVer version to release (e.g. 0.2.1)'
        required: true

permissions:
  contents: write

defaults:
  run:
    shell: bash

env:
  BIN_NAME: transmission-tui
  CARGO_TERM_COLOR: always

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version input
        id: meta
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          if [[ ! "$INPUT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+([+-][0-9A-Za-z.-]+)?$ ]]; then
            echo "The provided version '$INPUT_VERSION' is not a valid SemVer string" >&2
            exit 1
          fi

          crate_version=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name == env.BIN_NAME).version')
          if [[ "$crate_version" != "$INPUT_VERSION" ]]; then
            echo "Cargo.toml version ($crate_version) does not match workflow input ($INPUT_VERSION)." >&2
            exit 1
          fi

          if git rev-parse "refs/tags/v$INPUT_VERSION" >/dev/null 2>&1; then
            echo "Tag v$INPUT_VERSION already exists. Bump the version before releasing." >&2
            exit 1
          fi

          echo "version=$INPUT_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$INPUT_VERSION" >> "$GITHUB_OUTPUT"

  build:
    needs: preflight
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: linux-x86_64
            archive_format: gztar
            archive_suffix: tar.gz
            exe_suffix: ''
            strip: true
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: macos-aarch64
            archive_format: gztar
            archive_suffix: tar.gz
            exe_suffix: ''
            strip: true
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: windows-x86_64
            archive_format: zip
            archive_suffix: zip
            exe_suffix: '.exe'
            strip: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache build
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}-release

      - name: Build release binary
        run: cargo build --locked --release

      - name: Package artifacts
        id: package
        env:
          VERSION: ${{ needs.preflight.outputs.version }}
          TARGET: ${{ matrix.target }}
          ARTIFACT: ${{ matrix.artifact }}
          ARCHIVE_FORMAT: ${{ matrix.archive_format }}
          ARCHIVE_SUFFIX: ${{ matrix.archive_suffix }}
          EXE_SUFFIX: ${{ matrix.exe_suffix }}
          STRIP_BINARY: ${{ matrix.strip }}
        run: |
          set -euo pipefail
          bin_path="target/release/${BIN_NAME}${EXE_SUFFIX}"
          if [[ ! -f "$bin_path" ]]; then
            echo "Release binary not found at $bin_path" >&2
            exit 1
          fi

          if [[ "$STRIP_BINARY" == "true" ]]; then
            strip "$bin_path"
          fi

          pkg_stem="${BIN_NAME}-v${VERSION}-${ARTIFACT}"
          stage_dir="pack/$pkg_stem"
          mkdir -p "$stage_dir"
          cp "$bin_path" "$stage_dir/"
          [[ -f README.md ]] && cp README.md "$stage_dir/"

          mkdir -p dist
          archive_base="dist/$pkg_stem"
          export ARCHIVE_BASE="$archive_base" ROOT_DIR=pack BASE_DIR="$pkg_stem" FORMAT="$ARCHIVE_FORMAT"
          python3 - <<'PY'
          import os, shutil
          archive_base = os.environ['ARCHIVE_BASE']
          root_dir = os.environ['ROOT_DIR']
          base_dir = os.environ['BASE_DIR']
          fmt = os.environ['FORMAT']
          shutil.make_archive(archive_base, fmt, root_dir=root_dir, base_dir=base_dir)
          PY

          archive_path="${archive_base}.${ARCHIVE_SUFFIX}"
          echo "archive=$archive_path" >> "$GITHUB_OUTPUT"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ steps.package.outputs.archive }}

  release:
    needs: [preflight, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate checksums
        run: |
          set -euo pipefail
          cd dist
          sha256sum * > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.preflight.outputs.tag }}
          name: transmission-tui v${{ needs.preflight.outputs.version }}
          generate_release_notes: true
          files: dist/*
